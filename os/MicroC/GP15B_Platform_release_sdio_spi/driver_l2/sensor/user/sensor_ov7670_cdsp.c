/**************************************************************************
 *                                                                        *
 *         Copyright (c) 2014 by Generalplus Inc.                         *
 *                                                                        *
 *  This software is copyrighted by and is the property of Generalplus    *
 *  Inc. All rights are reserved by Generalplus Inc.                      *
 *  This software may only be used in accordance with the                 *
 *  corresponding license agreement. Any unauthorized use, duplication,   *
 *  distribution, or disclosure of this software is expressly forbidden.  *
 *                                                                        *
 *  This Copyright notice MUST not be removed or modified without prior   *
 *  written consent of Generalplus Technology Co., Ltd.                   *
 *                                                                        *
 *  Generalplus Inc. reserves the right to modify this software           *
 *  without notice.                                                       *
 *                                                                        *
 *  Generalplus Inc.                                                      *
 *  No.19, Industry E. Rd. IV, Hsinchu Science Park                       *
 *  Hsinchu City 30078, Taiwan, R.O.C.                                    *
 *                                                                        *
 **************************************************************************/
#include "driver_l1.h"
#include "drv_l1_power.h"
#include "drv_l1_interrupt.h"
#include "drv_l1_timer.h"
#include "drv_l1_i2c.h"
#include "drv_l1_csi.h"
#include "drv_l1_cdsp.h"
#include "drv_l1_front.h"
#include "drv_l2_cdsp.h"
#include "drv_l2_cdsp_config.h"
#include "drv_l2_sensor.h"
#include "drv_l2_sccb.h"

#if (defined _SENSOR_OV7670_CDSP) && (_SENSOR_OV7670_CDSP == 1)
/**************************************************************************
 *                           C O N S T A N T S                            *
 **************************************************************************/
#define OV7670_ID			0x42
#define OV7670_WIDTH		640
#define OV7670_HEIGHT		480
#define OV7670_YUYV			0x00
#define OV7670_BAYER_RAW	0x01
#define COLOR_BAR			0x02
#define COLOR_BAR_EN 		0

/**************************************************************************
 *                          D A T A    T Y P E S                          *
 **************************************************************************/
typedef struct regval8_s 
{
	INT8U reg_num;
	INT8U value;
} regval8_t;

/**************************************************************************
 *                         G L O B A L    D A T A                         *
 **************************************************************************/
#if SCCB_MODE == SCCB_GPIO
	static void *ov7670_handle;
#elif SCCB_MODE == SCCB_HW_I2C
	static drv_l1_i2c_bus_handle_t ov7670_handle; 
#endif

static const regval8_t ov7670_reset_table[] = 
{
	{ 0x12, 0x80 },
	{ 0xFF, 0xFF }
};

static const regval8_t ov7670_yuv_init[] = 
{
#if 1
	{0x11, 0x02}, // 30fps
	{0x15, 0x42}, //use Hsync mode and reverse Vsync
	    	
	{0x3a, 0x04},
	{0x12, OV7670_YUYV},

	//h set, hsize need more than 5pixel	
	{0x17, 0x12},	//HSTART[10:3]
	{0x18, 0x01},	//HSTOP[10:3]
	{0x32, 0xb6},	//[7:6] [5:3]=HSTOP[2:0]; [2:0]=HSTART[2:0]
	
	//v set
	{0x19, 0x02},
	{0x1a, 0x7a},
	{0x03, 0x0a},
	
	{0x0c, 0x00},
	{0x3e, 0x00},
	{0x70, 0x3a},
	{0x71, 0x35},
	{0x72, 0x11},
	{0x73, 0xf0},
	{0xa2, 0x02},

	{0x7a, 0x24},
	{0x7b, 0x04},
	{0x7c, 0x0a},
	{0x7d, 0x17},
	{0x7e, 0x32},
	{0x7f, 0x3f},
	{0x80, 0x4c},
	{0x81, 0x58},
	{0x82, 0x64},
	{0x83, 0x6f},
	{0x84, 0x7a},
	{0x85, 0x8c},
	{0x86, 0x9e},
	{0x87, 0xbb},
	{0x88, 0xd2},
	{0x89, 0xe5},

	{0x13, 0xe0},
	{0x00, 0x00},
	{0x10, 0x00},
	{0x0d, 0x40},
	{0x14, 0x18},
	{0xa5, 0x02},
	{0xab, 0x03},
	{0x24, 0x95},
	{0x25, 0x33},
	{0x26, 0xe3},
	{0x9f, 0x78},
	{0xa0, 0x68},
	{0xa1, 0x03},
	{0xa6, 0xd8},
	{0xa7, 0xd8},
	{0xa8, 0xf0},
	{0xa9, 0x90},
	{0xaa, 0x94},
	{0x13, 0xe5},
                     
	{0x0e, 0x61},
	{0x0f, 0x4b},
	{0x16, 0x02},
	{0x1e, 0x3f}, 	//Flip & Mirror
	{0x21, 0x02},
	{0x22, 0x91},
	{0x29, 0x07},
	{0x33, 0x0b},
	{0x35, 0x0b},
	{0x37, 0x1d},
	{0x38, 0x71},
	{0x39, 0x2a},
	{0x3c, 0x78},
	{0x4d, 0x40},
	{0x4e, 0x20},
	{0x69, 0x00},
		
	/* 30FPS */
	{0x6b, 0x8a},	// pclk*6	
		
	/* 27 FPS */	
	//{0x6b, 0xca},	// pclk*8
		
	/* 15 FPS */	
	//{0x6b, 0xca},	// pclk*8
		
	/* 10 FPS */
	//{0x6b, 0x4a},	// pclk*4
		
	/* 7 FPS */
	//{0x6b, 0x4a},	// pclk*4
	
	{0x2a, 0x00},	// horizontal dummy byte
	{0x2b, 0x08},
	
	{0x2d, 0x40},	// vertical dummy byte
	{0x2e, 0x00},
		
	{0x74, 0x10},
	{0x8d, 0x4f},
	{0x8e, 0x00},
	{0x8f, 0x00},
	{0x90, 0x00},
	{0x91, 0x00},
                             
	{0x96, 0x00},
	{0x9a, 0x80},
	{0xb0, 0x84},
	{0xb1, 0x0c},
	{0xb2, 0x0e},
	{0xb3, 0x82},
	{0xb8, 0x0a},
                     
	{0x43, 0x0a},
	{0x44, 0xf0},
	{0x45, 0x44},
	{0x46, 0x7a},
	{0x47, 0x27},
	{0x48, 0x3c},
	{0x59, 0xbc},
	{0x5a, 0xde},
	{0x5b, 0x54},
	{0x5c, 0x8a},
	{0x5d, 0x4b},
	{0x5e, 0x0f},
	{0x6c, 0x0a},
	{0x6d, 0x55},
	{0x6e, 0x11},
	{0x6f, 0x9e},
                     
	{0x6a, 0x40},
	{0x01, 0x40},
	{0x02, 0x40},
	{0x13, 0xe7},

	{0x4f, 0x80},
	{0x50, 0x80},
	{0x51, 0x00},
	{0x52, 0x22},
	{0x53, 0x5e},
	{0x54, 0x80},
	{0x58, 0x9e},
                     
	{0x62, 0x08},
	{0x63, 0x8f},
	{0x65, 0x00},
	{0x64, 0x08},
	{0x94, 0x08},
	{0x95, 0x0c},
	{0x66, 0x05},
                     
	{0x41, 0x08},
	{0x3f, 0x00},
	{0x75, 0x05},
	{0x76, 0xe1},
	{0x4c, 0x00},
	{0x77, 0x01},
	{0x3d, 0xc2},
	{0x4b, 0x09},
	{0xc9, 0x60},
	{0x41, 0x38},
	{0x56, 0x40},
                     
	{0x34, 0x11},
	
	{0x3b, 0xca},	//enable night mode
	//{0x3b, 0x4a},	//disable night mode

	{0xa4, 0x88},
	{0x96, 0x00},
	{0x97, 0x30},
	{0x98, 0x20},
	{0x99, 0x30},
	{0x9a, 0x84},
	{0x9b, 0x29},
	{0x9c, 0x03},
	{0x9d, 0x98},
	{0x9e, 0x7f},
	{0x78, 0x04},
                     
	{0x79, 0x01},
	{0xc8, 0xf0},
	{0x79, 0x0f},
	{0xc8, 0x00},
	{0x79, 0x10},
	{0xc8, 0x7e},
	{0x79, 0x0a},
	{0xc8, 0x80},
	{0x79, 0x0b},
	{0xc8, 0x01},
	{0x79, 0x0c},
	{0xc8, 0x0f},
	{0x79, 0x0d},
	{0xc8, 0x20},
	{0x79, 0x09},
	{0xc8, 0x80},
	{0x79, 0x02},
	{0xc8, 0xc0},
	{0x79, 0x03},
	{0xc8, 0x40},
	{0x79, 0x05},
	{0xc8, 0x30},
	{0x79, 0x26},
		
//	{0x3b, 0x00},    // 60Hz = 0x00, 50Hz = 0x08
	{0x3b, 0x08},    // 60Hz = 0x00, 50Hz = 0x08
//	{0x6b, 0x4a},
//	{0x6b, 0x0a},

/*
	{0x11, 0x81},    // 15fps
	{0x6b, 0x0a},
	{0x92, 0x40},
	{0x9d, 0x55},
	{0x9e, 0x47},
	{0xa5, 0x02},
	{0xab, 0x03},
*/
	{0xff, 0xff}

#else
#if 0	// pclk
	{0x6b, 0x0a},
	{0x11, 0x00},	// 15 FPS
#elif 1	// pclk*4
	{0x6b, 0x4a},
	{0x11, 0x01},	// 30.35 FPS
#elif 0	// pclk*6
	{0x6b, 0x8a},
	{0x11, 0x02},	// 33.76 FPS
#elif 0	// pclk*8
	{0x6b, 0xca},
	{0x11, 0x03},	// 36.58 FPS
#endif
	
	{0x2a, 0x00},	// horizontal dummy byte
	{0x2b, 0x08},
	
	{0x2d, 0x00},	// vertical dummy byte
	{0x2e, 0x00},

	{0x09, 0x01},		// TBD: save power here
	{0x3a, 0x04},		// bit[4]: Force U and V output value for testing
	{0x67, 0x77},		// Force U value when testing
	{0x68, 0x88},		// Force V value when testing
	
	{0x15, 0x42},		//use Hsync mode and reverse Vsync
	{0x12, OV7670_YUYV},//YUYV
	
	//h set, hsize need more than 5pixel
	{0x17, 0x12},
	{0x18, 0x01},
	{0x32, 0xb6},
	
	//v set
	{0x19, 0x02},
	{0x1a, 0x7a},
	{0x03, 0x0a},
	
	{0x0c, 0x00},
	{0x3e, 0x00},
	{0x70, 0x3a},
	{0x71, 0x35},
	{0x72, 0x11},
	{0x73, 0xf0},
	{0xa2, 0x02},

	{0x7a, 0x24},
	{0x7b, 0x04},
	{0x7c, 0x0a},
	{0x7d, 0x17},
	{0x7e, 0x32},
	{0x7f, 0x3f},
	{0x80, 0x4c},
	{0x81, 0x58},
	{0x82, 0x64},
	{0x83, 0x6f},
	{0x84, 0x7a},
	{0x85, 0x8c},
	{0x86, 0x9e},
	{0x87, 0xbb},
	{0x88, 0xd2},
	{0x89, 0xe5},

	{0x13, 0xe0},
	{0x00, 0x00},
	{0x10, 0x00},
	{0x0d, 0x40},
	{0x14, 0x18},
	{0xa5, 0x02},
	{0xab, 0x03},
	{0x24, 0x95},
	{0x25, 0x33},
	{0x26, 0xe3},
	{0x9f, 0x78},
	{0xa0, 0x68},
	{0xa1, 0x03},
	{0xa6, 0xd8},
	{0xa7, 0xd8},
	{0xa8, 0xf0},
	{0xa9, 0x90},
	{0xaa, 0x94},
	{0x13, 0xe5},

	{0x0e, 0x61},
	{0x0f, 0x4b},
	{0x16, 0x02},
	{0x1e, 0x3f}, 	// Flip (bit4) & Mirror (bit5)
	{0x21, 0x02},
	{0x22, 0x91},
	{0x29, 0x07},
	{0x33, 0x0b},
	{0x35, 0x0b},
	{0x37, 0x1d},
	{0x38, 0x71},
	{0x39, 0x2a},
	{0x3c, 0x78},
	{0x4d, 0x40},
	{0x4e, 0x20},
	{0x69, 0x00},

	{0x74, 0x10},
	{0x8d, 0x4f},
	{0x8e, 0x00},
	{0x8f, 0x00},
	{0x90, 0x00},
	{0x91, 0x00},

	{0x96, 0x00},
	{0x9a, 0x80},
	{0xb0, 0x84},
	{0xb1, 0x0c},
	{0xb2, 0x0e},
	{0xb3, 0x82},
	{0xb8, 0x0a},

	{0x43, 0x0a},
	{0x44, 0xf0},
	{0x45, 0x44},
	{0x46, 0x7a},
	{0x47, 0x27},
	{0x48, 0x3c},
	{0x59, 0xbc},
	{0x5a, 0xde},
	{0x5b, 0x54},
	{0x5c, 0x8a},
	{0x5d, 0x4b},
	{0x5e, 0x0f},
	{0x6c, 0x0a},
	{0x6d, 0x55},
	{0x6e, 0x11},
	{0x6f, 0x9e},

	{0x6a, 0x40},
	{0x01, 0x40},
	{0x02, 0x40},
	{0x13, 0xe7},

	{0x4f, 0x80},
	{0x50, 0x80},
	{0x51, 0x00},
	{0x52, 0x22},
	{0x53, 0x5e},
	{0x54, 0x80},
	{0x58, 0x9e},

	{0x62, 0x08},
	{0x63, 0x8f},
	{0x65, 0x00},
	{0x64, 0x08},
	{0x94, 0x08},
	{0x95, 0x0c},
	{0x66, 0x05},

	{0x41, 0x08},
	{0x3f, 0x00},
	{0x75, 0x05},
	{0x76, 0xe1},
	{0x4c, 0x00},
	{0x77, 0x01},
	{0x3d, 0xc2},
	{0x4b, 0x09},
	{0xc9, 0x60},
	{0x41, 0x38},
	{0x56, 0x40},

	{0x34, 0x11},
	{0x3b, 0xca},	// enable night mode
//	{0x3b, 0x4a},	// disable night mode

	{0xa4, 0x88},
	{0x96, 0x00},
	{0x97, 0x30},
	{0x98, 0x20},
	{0x99, 0x30},
	{0x9a, 0x84},
	{0x9b, 0x29},
	{0x9c, 0x03},
	{0x9d, 0x98},
	{0x9e, 0x7f},
	{0x78, 0x04},

	{0x79, 0x01},
	{0xc8, 0xf0},
	{0x79, 0x0f},
	{0xc8, 0x00},
	{0x79, 0x10},
	{0xc8, 0x7e},
	{0x79, 0x0a},
	{0xc8, 0x80},
	{0x79, 0x0b},
	{0xc8, 0x01},
	{0x79, 0x0c},
	{0xc8, 0x0f},
	{0x79, 0x0d},
	{0xc8, 0x20},
	{0x79, 0x09},
	{0xc8, 0x80},
	{0x79, 0x02},
	{0xc8, 0xc0},
	{0x79, 0x03},
	{0xc8, 0x40},
	{0x79, 0x05},
	{0xc8, 0x30},
	{0x79, 0x26},
#if 1
	{0x3b, 0x00},	// 60Hz
#else	
	{0x3b, 0x08},	// 50Hz
#endif
	{0xff, 0xff}
#endif	
};

static const regval8_t ov7670_raw_K300[] =
{
#if 0	//clock bypass		
	{0x11, 0x80},			
#else	
	{0x11, 0x00},		
#endif	
	
	{0x15, 0x42},	//use Hsync mode and reverse Vsync
	{0x3a, 0x04},	
	{0x12, 0x01},	//RAW
#if 0	
	//h set	
	{0x17, 0x12},  //HSTART[10:3]
	{0x18, 0x01},  //HSTOP[10:3]
	{0x32, 0x84},  //[7:6] [5:3]=HSTOP[2:0]; [2:0]=HSTART[2:0]
	//v set
	{0x19, 0x01},
	{0x1a, 0x7a},
	{0x03, 0x0e},
#elif 0
	{0x17, 0x12},
	{0x18, 0x01},
	{0x32, 0xb6},
	{0x19, 0x02},
	{0x1a, 0x7a},
	{0x03, 0x0a},
#else //640x480
	{0x17, 0x11},
	{0x18, 0xB1},
	{0x32, 0x80},
	{0x19, 0x03},
	{0x1a, 0x7D},
	{0x03, 0x03},
#endif	

	{0x0c, 0x00},
	{0x3e, 0x00},
	{0x70, 0x3a},
	{0x71, 0x35},
	{0x72, 0x11},
	{0x73, 0xf0},
	{0xa2, 0x29},

	{0x7a, 0x24},
	{0x7b, 0x04},
	{0x7c, 0x0a},
	{0x7d, 0x17},
	{0x7e, 0x32},
	{0x7f, 0x3f},
	{0x80, 0x4c},
	{0x81, 0x58},
	{0x82, 0x64},
	{0x83, 0x6f},
	{0x84, 0x7a},
	{0x85, 0x8c},
	{0x86, 0x9e},
	{0x87, 0xbb},
	{0x88, 0xd2},
	{0x89, 0xe5},

	{0x13, 0xe0},
	{0x00, 0x00},
	{0x10, 0x00},
	{0x0d, 0x40},
	{0x14, 0x18},
	{0xa5, 0x02},
	{0xab, 0x03},
	{0x24, 0x95},
	{0x25, 0x33},
	{0x26, 0xe3},
	{0x9f, 0x78},
	{0xa0, 0x68},
	{0xa1, 0x03},
	{0xa6, 0xd8},
	{0xa7, 0xd8},
	{0xa8, 0xf0},
	{0xa9, 0x90},
	{0xaa, 0x94},
	{0x13, 0xe5},

	{0x0e, 0x61},
	{0x0f, 0x4b},
	{0x16, 0x02},
	{0x1e, 0x3f}, 	// Flip & Mirror
	{0x21, 0x02},
	{0x22, 0x91},
	{0x29, 0x07},
	{0x33, 0x0b},
	{0x35, 0x0b},
	{0x37, 0x1d},
	{0x38, 0x71},
	{0x39, 0x2a},
	{0x3c, 0x78},
	{0x4d, 0x40},
	{0x4e, 0x20},
	{0x69, 0x00},
		
#if 0 //PLL
	{0x6b, 0x0a},	//ByPass
#elif 1
	{0x6b, 0x4a},	// pclk*4	
	{0x11, 0x01},	// 30.5 FPS
#elif 0
	{0x6b, 0x8a},	// pclk*6
#elif 0		
	{0x6b, 0xca},	// pclk*8
#endif				
		
	{0x74, 0x10},
	{0x8d, 0x4f},
	{0x8e, 0x00},
	{0x8f, 0x00},
	{0x90, 0x00},
	{0x91, 0x00},
	
#if 0 //redurce Frame Ratecan increase Dummy Line
	{0x92, 0xE0},	//Dummy Line_L
	{0x93, 0x01},	//Dummy Line_H
#endif

	{0x96, 0x00},
	{0x9a, 0x80},
	{0xb0, 0x84},
	{0xb1, 0x0c},
	{0xb2, 0x0e},
	{0xb3, 0x82},
	{0xb8, 0x0a},

	{0x43, 0x0a},
	{0x44, 0xf0},
	{0x45, 0x44},
	{0x46, 0x7a},
	{0x47, 0x27},
	{0x48, 0x3c},
	{0x59, 0xbc},
	{0x5a, 0xde},
	{0x5b, 0x54},
	{0x5c, 0x8a},
	{0x5d, 0x4b},
	{0x5e, 0x0f},
	{0x6c, 0x0a},
	{0x6d, 0x55},
	{0x6e, 0x11},
	{0x6f, 0x9e},

	{0x6a, 0x40},
	{0x01, 0x40},
	{0x02, 0x40},
	//{0x13, 0x80},	//0xe7: enable AWB/AGC/AEC,0x80:disbale AE...
	{0x13, 0xe7},
	
	{0x4f, 0x80},
	{0x50, 0x80},
	{0x51, 0x00},
	{0x52, 0x22},
	{0x53, 0x5e},
	{0x54, 0x80},
	{0x58, 0x9e},

	{0x62, 0x08},
	{0x63, 0x8f},
	{0x65, 0x00},
	{0x64, 0x08},
	{0x94, 0x08},
	{0x95, 0x0c},
	{0x66, 0x05},

	{0x41, 0x08},
	{0x3f, 0x00},
	{0x75, 0x05},
	{0x76, 0xe1},
	{0x4c, 0x00},
	{0x77, 0x01},
	//{0x3d, 0xc2},
	{0x3d, 0x08},//disable gamma and uv saturation
	{0x4b, 0x09},
	{0xc9, 0x60},
	{0x41, 0x38},
	{0x56, 0x40},

	{0x34, 0x11},
	{0x3b, 0x4a},//disable  night mode
	{0xa4, 0x88},
	{0x96, 0x00},
	{0x97, 0x30},
	{0x98, 0x20},
	{0x99, 0x30},
	{0x9a, 0x84},
	{0x9b, 0x29},
	{0x9c, 0x03},
	{0x9d, 0x98},
	{0x9e, 0x7f},
	{0x78, 0x04},
	
	{0x79, 0x01},
	{0xc8, 0xf0},
	{0x79, 0x0f},
	{0xc8, 0x00},
	{0x79, 0x10},
	{0xc8, 0x7e},
	{0x79, 0x0a},
	{0xc8, 0x80},
	{0x79, 0x0b},
	{0xc8, 0x01},
	{0x79, 0x0c},
	{0xc8, 0x0f},
	{0x79, 0x0d},
	{0xc8, 0x20},
	{0x79, 0x09},
	{0xc8, 0x80},
	{0x79, 0x02},
	{0xc8, 0xc0},
	{0x79, 0x03},
	{0xc8, 0x40},
	{0x79, 0x05},
	{0xc8, 0x30},
	{0x79, 0x26},
#if 1	
	{0x3b, 0x00},		//60Hz = 0x00, 
#else	
	{0x3b, 0x08}    	//50Hz = 0x08
#endif	
	{0xFF, 0xFF}
};

static INT32S ov7670_sccb_open(void)
{
#if SCCB_MODE == SCCB_GPIO
	ov7670_handle = drv_l2_sccb_open(OV7670_ID, 8, 8);
	if(ov7670_handle == 0) {
		DBG_PRINT("Sccb open fail.\r\n");
		return STATUS_FAIL;
	}
#elif SCCB_MODE == SCCB_HW_I2C	
	drv_l1_i2c_init();
	ov7670_handle.slaveAddr = OV7670_ID;
	ov7670_handle.clkRate = 100;
#endif
	return STATUS_OK;
}

static void ov7670_sccb_close(void)
{
#if SCCB_MODE == SCCB_GPIO
	if(ov7670_handle) {
		drv_l2_sccb_close(ov7670_handle);
		ov7670_handle = NULL;
	}	
#elif SCCB_MODE == SCCB_HW_I2C	
	drv_l1_i2c_uninit();
	ov7670_handle.slaveAddr = 0;
	ov7670_handle.clkRate = 0;
#endif
}

static INT32S ov7670_sccb_write(INT8U reg, INT8U value)
{
#if SCCB_MODE == SCCB_GPIO
	return drv_l2_sccb_write(ov7670_handle, reg, value);

#elif SCCB_MODE == SCCB_HW_I2C	
	INT8U data[2];
	
	data[0] = reg;
	data[1] = value;
	return drv_l1_i2c_bus_write(&ov7670_handle, data, 2);
#endif
}

#if 0
static INT32S ov7670_sccb_read(INT8U reg, INT8U *value)
{
#if SCCB_MODE == SCCB_GPIO
	INT16U data;
	
	if(drv_l2_sccb_read(ov7670_handle, reg, &data) >= 0) {
		*value = (INT8U)data;
		return STATUS_OK;
	} else {
		*value = 0xFF;
		return STATUS_FAIL;
	}
#elif SCCB_MODE == SCCB_HW_I2C	
	INT8U data[1];
	
	data[0] = reg;
	if(drv_l1_i2c_bus_write(&ov7670_handle, data, 1) < 0) {
		*value = 0xFF;
		return STATUS_FAIL;
	}
	
	if(drv_l1_i2c_bus_read(&ov7670_handle, data, 1) < 0) {
		*value = 0xFF;
		return STATUS_FAIL;
	}
	
	*value = data[0];
#endif
	return STATUS_OK;
}
#endif

static INT32S ov7670_sccb_write_table(regval8_t *pTable)
{
	while(1) {
		if(pTable->reg_num == 0xFF && pTable->value == 0xFF) {
			break;
		}
		
		if(ov7670_sccb_write(pTable->reg_num, pTable->value) < 0) {
			DBG_PRINT("sccb write fail.\r\n");
			continue;
		}
		pTable++;
	}
	return STATUS_OK;
}

/**
 * @brief   ov7670 initialization function
 * @param   sensor format parameters
 * @return 	none
 */
static void ov7670_cdsp_init(void)
{
	// Turn on LDO 2.8V for CSI sensor
	drv_l1_power_ldo_28_ctrl(1, LDO_LDO28_2P8V);
	
	// mclk output
	drv_l2_sensor_set_mclkout(ov7670_cdsp_ops.info[0].mclk);
			
	/* request SCCB */
	ov7670_sccb_open();
	
	// init sensor
	ov7670_sccb_write_table((regval8_t *)ov7670_reset_table);
	OSTimeDly(20); 
	
	// cdsp init
	drv_l2_cdsp_open();
	DBG_PRINT("Sensor OV7670 cdsp init completed\r\n");
}	

/**
 * @brief   ov7670 un-initialization function
 * @param   sensor format parameters
 * @return 	none
 */
static void ov7670_cdsp_uninit(void)
{
	// disable mclk
	drv_l2_sensor_set_mclkout(MCLK_NONE);
	
	// cdsp disabale
	drv_l2_cdsp_close();
	
	// release sccb
	ov7670_sccb_close();
	
	// Turn off LDO 2.8V for CSI sensor
	drv_l1_power_ldo_28_ctrl(0, LDO_LDO28_2P8V);
}	

/**
 * @brief   ov7670 stream start function
 * @param   info index
 *			
 * @return 	none
 */
static void ov7670_cdsp_stream_on(INT32U index, INT32U bufA, INT32U bufB)
{
	INT16U target_w, target_h;
	gpCdspFmt_t format;

	// set sensor
	DBG_PRINT("%s = %d\r\n", __func__, index); 
	switch(index)
	{
	case 0:
	case 1:
		ov7670_sccb_write_table((regval8_t *)ov7670_yuv_init);
		break;
		
	case 2:
		ov7670_sccb_write_table((regval8_t *)ov7670_raw_K300);
		break;
		
	default:
		while(1);
	}
	
	// mclk output
	drv_l2_sensor_set_mclkout(ov7670_cdsp_ops.info[index].mclk);

	// set cdsp format
	format.image_source = C_CDSP_FRONT;
	format.input_format = ov7670_cdsp_ops.info[index].input_format;
	format.output_format = ov7670_cdsp_ops.info[index].output_format;
	target_w = ov7670_cdsp_ops.info[index].target_w;
	target_h = ov7670_cdsp_ops.info[index].target_h;
	format.hpixel = ov7670_cdsp_ops.info[index].sensor_w;
	format.vline = ov7670_cdsp_ops.info[index].sensor_h;
	format.hoffset = ov7670_cdsp_ops.info[index].hoffset;
	format.voffset = ov7670_cdsp_ops.info[index].voffset;
	format.sensor_timing_mode = ov7670_cdsp_ops.info[index].interface_mode;
	format.sensor_hsync_mode = ov7670_cdsp_ops.info[index].hsync_active;
	format.sensor_vsync_mode = ov7670_cdsp_ops.info[index].vsync_active;
	if(drv_l2_cdsp_set_fmt(&format) < 0) {
		DBG_PRINT("cdsp set fmt err!!!\r\n");
	}
	
	// scale down
	if((format.hpixel > target_w) || (format.vline > target_h)) {
		drv_l2_cdsp_set_yuv_scale(target_w, target_h);
	}
	
	// cdsp start
	drv_l2_cdsp_stream_on(DISABLE, bufA, bufB);
}

/**
 * @brief   ov7670 stream stop function
 * @param   none
 * @return 	none
 */ 
static void ov7670_cdsp_stream_off(void)
{
	drv_l2_cdsp_stream_off();
}	

/**
 * @brief   ov7670 get info function
 * @param   none
 * @return 	pointer to sensor information data
 */ 
static drv_l2_sensor_info_t* ov7670_cdsp_get_info(INT32U index)
{
	if(index > (MAX_INFO_NUM - 1)) {
		return NULL;
	} else {
		return (drv_l2_sensor_info_t*)&ov7670_cdsp_ops.info[index];
	}
}

/*********************************************
*	sensor ops declaration
*********************************************/
const drv_l2_sensor_ops_t ov7670_cdsp_ops =
{
	SENSOR_OV7670_CDSP_NAME,			/* sensor name */
	ov7670_cdsp_init,
	ov7670_cdsp_uninit,
	ov7670_cdsp_stream_on,
	ov7670_cdsp_stream_off,
	ov7670_cdsp_get_info,
	{
		/* 1st info */
		{
			MCLK_24M,					/* MCLK */
			V4L2_PIX_FMT_VYUY,			/* input format */
			V4L2_PIX_FMT_VYUY,			/* output format */
			30,							/* FPS in sensor */
			WIDTH_640,					/* target width */
			HEIGHT_480, 				/* target height */
			WIDTH_640,					/* sensor width */
			HEIGHT_480, 				/* sensor height */
		#if 1
			0x90,						/* sensor h offset */ 	
			0x53,						/* sensor v offset */
		#else	
			0x90,						/* sensor h offset */
			0x14,						/* sensor v offset */
		#endif	
			MODE_CCIR_601,				/* input interface */
			MODE_NONE_INTERLACE,		/* interlace mode */			
			MODE_ACTIVE_HIGH,			/* hsync pin active level */
			MODE_ACTIVE_HIGH,			/* vsync pin active level */
		},
		/* 2st info */
		{
			MCLK_24M,					/* MCLK */
			V4L2_PIX_FMT_VYUY,			/* input format */
			V4L2_PIX_FMT_VYUY,			/* output format */
			30,							/* FPS in sensor */
			WIDTH_320,					/* target width */
			HEIGHT_240, 				/* target height */
			WIDTH_640,					/* sensor width */
			HEIGHT_480, 				/* sensor height */
		#if 1
			0x90,						/* sensor h offset */ 	
			0x53,						/* sensor v offset */
		#else	
			0x90,						/* sensor h offset */
			0x14,						/* sensor v offset */
		#endif	
			MODE_CCIR_601,				/* input interface */
			MODE_NONE_INTERLACE,		/* interlace mode */			
			MODE_ACTIVE_HIGH,			/* hsync pin active level */
			MODE_ACTIVE_HIGH,			/* vsync pin active level */
		},
		/* 3nd info */	
		{
			MCLK_24M,					/* MCLK */
			V4L2_PIX_FMT_SGRBG8,		/* input format */
			V4L2_PIX_FMT_VYUY,			/* output format */
			30,							/* FPS in sensor */	
			WIDTH_640,					/* target width */
			HEIGHT_480, 				/* target height */		
			WIDTH_640,					/* sensor width */
			HEIGHT_480, 				/* sensor height */
			0x90,						/* sensor h offset */ 
			0x14,						/* sensor v offset */
			MODE_CCIR_601,				/* input interface */
			MODE_NONE_INTERLACE,		/* interlace mode */			
			MODE_ACTIVE_HIGH,			/* hsync pin active level */
			MODE_ACTIVE_HIGH,			/* vsync pin active level */
		}
	}
};
#endif //(defined _SENSOR_OV7670_CDSP) && (_SENSOR_OV7670_CDSP == 1)
